{% extends 'base/base.html' %}
{% load humanize %}
{% load static %}
{% load mathfilters %}
{% block title %}
Dashboard
{% endblock title %}

{% block page_title %}
Dashboard
{% endblock page_title %}

{% block custom_js_css_link %}
<link rel="stylesheet" type="text/css" href="{% static 'custom/custom.css' %}">
{% endblock custom_js_css_link %}

{% block breadcrumb_title %}
{% endblock breadcrumb_title %}

{% block main_content %}
<div class="row">
  <div class="col-md-6 col-xl-3">
    <div class="card" id="tooltip-container">
      <div class="card-body">
        <i class="fa fa-info-circle text-muted float-end" data-bs-container="#tooltip-container" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Total Number of Targets/Domains"></i>
        <h4 class="mt-0 font-16">Total Targets</h4>
        <h2 class="text-primary my-3 text-center"><span data-plugin="counterup">{{domain_count|intcomma}}</span></h2>
        <div id="targets_chart"></div>
        <p class="text-success mb-0 mt-2"><span class="badge rounded-pill float-end">&nbsp;</span></p>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-xl-3">
    <div class="card" id="tooltip-container1">
      <div class="card-body">
        <i class="fa fa-info-circle text-muted float-end" data-bs-container="#tooltip-container1" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Total Number of Subdomains discovered by reNgine across all targets."></i>
        <h4 class="mt-0 font-16">Total Subdomains</h4>
        <h2 class="text-primary my-3 text-center"><span data-plugin="counterup">{{subdomain_count|intcomma}}</span></h2>
        <div id="subdomains_chart"></div>
        <p class="text-success mb-0 mt-2"><span class="badge badge-soft-success rounded-pill float-end">Alive Subdomains: {{alive_count|intcomma}}</span></p>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-xl-3">
    <div class="card" id="tooltip-container2">
      <div class="card-body">
        <i class="fa fa-info-circle text-muted float-end" data-bs-container="#tooltip-container2" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Total Endpoints/URLs discovered by reNgine across all targets & subdomains."></i>
        <h4 class="mt-0 font-16">Total Endpoints</h4>
        <h2 class="text-primary my-3 text-center">{{endpoint_count|intcomma}}</h2>
        <div id="endpoint_chart"></div>
        <p class="text-success mb-0 mt-2"><span class="badge badge-soft-success rounded-pill float-end">Alive Endpoints: {{endpoint_alive_count|intcomma}}</span></p>
      </div>
    </div>
  </div>

  <div class="col-md-6 col-xl-3">
    <div class="card" id="tooltip-container3">
      <div class="card-body">
        <i class="fa fa-info-circle text-muted float-end" data-bs-container="#tooltip-container3" data-bs-toggle="tooltip" data-bs-placement="bottom" title="More Info"></i>
        <h4 class="mt-0 font-16 text-danger">Total Vulnerabilities</h4>
        <h2 class="text-danger my-3 text-center"><span data-plugin="counterup">{{total_vul_count|intcomma}}</span></h2>
        <div id="vuln_chart"></div>
        <p class="text-success mb-0 mt-2"><span class="badge badge-soft-danger rounded-pill float-end">{{critical_count}}</b> Critical, <b>{{high_count}}</b> High, {{medium_count}} Medium Vulnerabilities</span></p>
      </div>
    </div>
  </div>
</div>

<div class="row row-eq-height">
  <div class="col-4">
    <div class="card" style="height: 100%">
      <div class="card-body">
        <h4 class="header-title mb-0">Vulnerability Breakdown by Severity</h4>
        <div id="cardCollpase19" class="collapse pt-3 show" dir="ltr">
          <div class="row mt-3 text-center">
            <div class="col-3">
              <p class="text-critical font-15 mb-1 text-truncate">Critical</p>
              <h4 class="text-critical">{{critical_count}}</h4>
            </div>
            <div class="col-3">
              <p class="text-danger font-15 mb-1 text-truncate">High</p>
              <h4 class="text-danger">{{high_count}}</h4>
            </div>
            <div class="col-3">
              <p class="text-warning font-15 mb-1 text-truncate">Medium</p>
              <h4 class="text-warning">{{medium_count}}</h4>
            </div>
            <div class="col-3">
              <p class="text-low font-15 mb-1 text-truncate">Low</p>
              <h4 class="text-low">{{low_count}}</h4>
            </div>
          </div>
          <div id="vulnerability-pie-chart" class="apex-charts"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-3">
    <div class="card" style="height: 100%">
      <div class="card-body">
        <h4 class="header-title mb-3">Most Vulnerable Targets<span class="float-end"><span class="badge badge-soft-danger rounded-pill">{{total_vul_count}} Vulnerabilities</span></span></h4>
        <div class="inbox-widget table-responsive" data-simplebar style="max-height: 407px;">
          <table class="table table-borderless table-nowrap table-hover table-centered m-0">
            <thead class="table-light">
              <tr>
                <th style="width: 40%">Target</th>
                <th style="width: 10%">Vulnerability Count</th>
                <th style="width: 50%">&nbsp;</th>
              </tr>
            </thead>
            <tbody>
              {% for item in most_vulnerable_target %}
              <tr onclick="window.location='scan/detail/vuln?domain={{item.name}}';" style="cursor: pointer;">
                <td>
                  <h5 class="m-0 fw-normal">{{item.name}}</h5>
                </td>
                <td>
                  {{item.num_vul}} Vulnerabilities
                </td>
                <td>
                  <div class="progress progress-sm m-0">
                    <div class="progress-bar br-30 bg-danger" role="progressbar" style="width: {% with percent=item.num_vul|div:total_vul_count %}{{percent|mul:100}}{% endwith %}%" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                </td>
              </tr>
              {% empty %}
              Not enough data.
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="col-3">
    <div class="card" style="height: 100%">
      <div class="card-body">
        <h4 class="header-title mb-3">Most Common Vulnerabilities</h4>
        <div class="inbox-widget table-responsive" data-simplebar style="max-height: 407px;">
          <table class="table table-borderless table-nowrap table-hover table-centered m-0">
            <thead class="table-light">
              <tr>
                <th style="width: 40%">Vulnerability Name</th>
                <th style="width: 10%">Count</th>
                <th style="width: 50%">Severity</th>
              </tr>
            </thead>
            <tbody>
              {% for item in most_common_vulnerability %}
              <tr onclick="window.location='scan/detail/vuln?vulnerability_name={{item.name}}';" style="cursor: pointer;">
                <td>
                  <h5 class="m-0 fw-normal">{{item.name}}</h5>
                </td>
                <td class="text-center">
                  {{item.count}}
                </td>
                <td>
                  <div class="t-rate">
                    {% if item.severity == 0 %}
                    <span class='badge badge-soft-info'>Info</span>
                    {% elif item.severity == 1 %}
                    <span class='badge badge-low'>Low</span>
                    {% elif item.severity == 2 %}
                    <span class='badge badge-warning'>Medium</span>
                    {% elif item.severity == 3 %}
                    <span class='badge badge-danger'>High</span>
                    {% elif item.severity == 4 %}
                    <span class='badge badge-soft-danger'>Critical</span>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% empty %}
              Not enough data.
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock main_content %}


{% block page_level_script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.29.0/apexcharts.min.js" integrity="sha512-fe6OklXva8AWoqdwgkE7Ni4uWgHGWxFQWZx4lYehzY2Qrst5YfogjAbnLd6egsoTrnjGI9/LYt1Ont2cKNbP2A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://apexcharts.com/samples/assets/irregular-data-series.js"></script>
<script src="https://apexcharts.com/samples/assets/ohlc.js"></script>
<script type="text/javascript">
var label_dates = ['{{last_7_dates.6}}', '{{last_7_dates.5}}', '{{last_7_dates.4}}', '{{last_7_dates.3}}', '{{last_7_dates.2}}', '{{last_7_dates.1}}', '{{last_7_dates.0}}'];

var fill_options = {
  type:"gradient",
  gradient: {
    type: "vertical",
    shadeIntensity: 1,
    inverseColors: !1,
    opacityFrom: .30,
    opacityTo: .05,
    stops: [35, 100]
  },
}

var target_chart_option = {
  chart: {
    type: "area",
    height: 90,
    sparkline: {
      enabled: !0
    }
  },
  stroke: {
    width: 2,
    curve: "smooth"
  },
  fill: {
    opacity: .2
  },
  series: [{
    name: "Targets Added",
    data: [{{targets_in_last_week.0}},{{targets_in_last_week.1}},{{targets_in_last_week.2}},{{targets_in_last_week.3}},{{targets_in_last_week.4}},{{targets_in_last_week.5}},{{targets_in_last_week.6}}]
  }],
  yaxis: {
    min: 0
  },
  labels: label_dates,
  colors: ['#2196f3'],
  subtitle: {
    text: "",
    offsetX: 10,
    offsetY: 35,
    style: {
      fontSize: "13px"
    }
  },
  fill: fill_options,
};
new ApexCharts(document.querySelector("#targets_chart"), target_chart_option).render();

var subdomains_chart_options = {
  chart: {
    type: "area",
    height: 90,
    sparkline: {
      enabled: !0
    }
  },
  stroke: {
    width: 2,
    curve: "smooth"
  },
  fill: {
    opacity: .2
  },
  series: [{
    name: "Subdomains Discovered",
    data: [{{subdomains_in_last_week.0}},{{subdomains_in_last_week.1}},{{subdomains_in_last_week.2}},{{subdomains_in_last_week.3}},{{subdomains_in_last_week.4}},{{subdomains_in_last_week.5}},{{subdomains_in_last_week.6}}]
  }],
  yaxis: {
    min: 0
  },
  labels: label_dates,
  colors: ['#2196f3'],
  subtitle: {
    text: "",
    offsetX: 10,
    offsetY: 35,
    style: {
      fontSize: "13px"
    }
  },
  fill: fill_options,
};
new ApexCharts(document.querySelector("#subdomains_chart"), subdomains_chart_options).render();

var endpoint_chart_options = {
  chart: {
    type: "area",
    height: 90,
    sparkline: {
      enabled: !0
    }
  },
  stroke: {
    width: 2,
    curve: "smooth"
  },
  fill: {
    opacity: .2
  },
  series: [{
    name: "Endpoints Discovered",
    data: [{{endpoints_in_last_week.0}},{{endpoints_in_last_week.1}},{{endpoints_in_last_week.2}},{{endpoints_in_last_week.3}},{{endpoints_in_last_week.4}},{{endpoints_in_last_week.5}},{{endpoints_in_last_week.6}}]
  }],
  yaxis: {
    min: 0
  },
  labels: label_dates,
  colors: ['#2196f3'],
  subtitle: {
    text: "",
    offsetX: 10,
    offsetY: 35,
    style: {
      fontSize: "13px"
    }
  },
  fill: fill_options,
};
new ApexCharts(document.querySelector("#endpoint_chart"), endpoint_chart_options).render();


var vuln_chart_options = {
  chart: {
    type: "area",
    height: 90,
    sparkline: {
      enabled: !0
    }
  },
  stroke: {
    width: 2,
    curve: "smooth"
  },
  fill: {
    opacity: .2
  },
  series: [{
    name: "Vulnerabilities Discovered",
    data: [{{vulns_in_last_week.0}},{{vulns_in_last_week.1}},{{vulns_in_last_week.2}},{{vulns_in_last_week.3}},{{vulns_in_last_week.4}},{{vulns_in_last_week.5}},{{vulns_in_last_week.6}}]
  }],
  yaxis: {
    min: 0
  },
  labels: label_dates,
  colors: ['#e7515a'],
  subtitle: {
    text: "",
    offsetX: 10,
    offsetY: 35,
    style: {
      fontSize: "13px"
    }
  },
  fill: fill_options,
};
new ApexCharts(document.querySelector("#vuln_chart"), vuln_chart_options).render();


// vulnerability summary pie chart
var options = {
  chart: {
    type: 'donut',
    height: 320,
  },
  colors: ['#D50000', '#F44336', '#FF6D00', '#FFD600', '#2962FF'],
  dataLabels: {
    enabled: false
  },
  legend: {
    show: !0,
    position: "bottom",
    horizontalAlign: "center",
    verticalAlign: "middle",
    floating: !1,
    fontSize: "15px",
    offsetX: 0,
    offsetY: 7
  },
  plotOptions: {
    pie: {
      donut: {
        size: '70%',
        background: 'transparent',
        labels: {
          show: true,
          name: {
            show: true,
            fontSize: '29px',
            fontFamily: 'Nunito, sans-serif',
            color: undefined,
            offsetY: -10
          },
          value: {
            show: true,
            fontSize: '26px',
            fontFamily: 'Nunito, sans-serif',
            color: '20',
            offsetY: 16,
            formatter: function (val) {
              return val
            }
          },
          total: {
            show: true,
            showAlways: true,
            label: 'Total',
            color: '#888ea8',
            formatter: function (w) {
              return w.globals.seriesTotals.reduce( function(a, b) {
                return a + b
              }, 0)
            }
          }
        }
      }
    }
  },
  series: [{{critical_count}}, {{high_count}}, {{medium_count}}, {{low_count}}, {{info_count}}],
  labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
  responsive: [{
    breakpoint: 1599,
    options: {
      chart: {
        height: 240
      },
      legend: {
        position: 'bottom'
      }
    },
    breakpoint: 1439,
    options: {
      chart: {
        width: '250px',
        height: '390px'
      },
    },
  }],
}

var chart = new ApexCharts(
  document.querySelector("#vulnerability-pie-chart"),
  options
);

chart.render()

var options = {
  series: [{
    name: "Ip is Used By Subdomains",
    data: [{{most_used_ip.6.count}}, {{most_used_ip.5.count}}, {{most_used_ip.4.count}}, {{most_used_ip.3.count}}, {{most_used_ip.2.count}}, {{most_used_ip.1.count}}, {{most_used_ip.0.count}}]
  }],
  chart: {
    type: 'bar',
    height: 350
  },
  plotOptions: {
    bar: {
      borderRadius: 4,
      horizontal: true,
    }
  },
  dataLabels: {
    enabled: false
  },
  xaxis: {
    categories: ['{{most_used_ip.6.address}}', '{{most_used_ip.5.address}}', '{{most_used_ip.4.address}}', '{{most_used_ip.3.address}}', '{{most_used_ip.2.address}}', '{{most_used_ip.1.address}}', '{{most_used_ip.0.address}}'],
  }
};

var chart = new ApexCharts(document.querySelector("#most_common_ip_chart"), options);
chart.render();

var options = {
  series: [{
    name: "Ports used by IPs",
    data: [{{most_used_port.6.count}}, {{most_used_port.5.count}}, {{most_used_port.4.count}}, {{most_used_port.3.count}}, {{most_used_port.2.count}}, {{most_used_port.1.count}}, {{most_used_port.0.count}}]
  }],
  chart: {
    type: 'bar',
    height: 350
  },
  plotOptions: {
    bar: {
      borderRadius: 4,
      horizontal: true,
    }
  },
  dataLabels: {
    enabled: false
  },
  xaxis: {
    categories: ['{{most_used_port.6.number}}/{{most_used_port.6.service_name}}', '{{most_used_port.5.number}}/{{most_used_port.5.service_name}}', '{{most_used_port.4.number}}/{{most_used_port.4.service_name}}', '{{most_used_port.3.number}}/{{most_used_port.3.service_name}}', '{{most_used_port.2.number}}/{{most_used_port.2.service_name}}', '{{most_used_port.1.number}}/{{most_used_port.1.service_name}}', '{{most_used_port.0.number}}/{{most_used_port.0.service_name}}'],
  }
};

var chart = new ApexCharts(document.querySelector("#most_common_port_chart"), options);
chart.render();


var options = {
  series: [{
    name: "Tech used by Subdomains",
    data: [{{most_used_tech.6.count}}, {{most_used_tech.5.count}}, {{most_used_tech.4.count}}, {{most_used_tech.3.count}}, {{most_used_tech.2.count}}, {{most_used_tech.1.count}}, {{most_used_tech.0.count}}]
  }],
  chart: {
    type: 'bar',
    height: 350
  },
  plotOptions: {
    bar: {
      borderRadius: 4,
      horizontal: true,
    }
  },
  dataLabels: {
    enabled: false
  },
  xaxis: {
    categories: ['{{most_used_tech.6.name}}', '{{most_used_tech.5.name}}', '{{most_used_tech.4.name}}', '{{most_used_tech.3.name}}', '{{most_used_tech.2.name}}', '{{most_used_tech.1.name}}', '{{most_used_tech.0.name}}'],
  }
};

var chart = new ApexCharts(document.querySelector("#most_common_tech_chart"), options);
chart.render();

</script>
{% endblock page_level_script %}
